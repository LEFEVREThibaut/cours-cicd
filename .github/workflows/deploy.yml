name: Test, Build and Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    if: contains(github.event.head_commit.message, '#deploy')
    runs-on: ubuntu-latest

    env:
      TAG: ${{ github.run_number }}
      IMAGE_NAME: ${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_REPOSITORY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js (si projet Node)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci --no-audit --no-fund || npm install --no-audit --no-fund

      - name: Run unit tests
        id: tests
        run: npm test

      # ---- En cas de succès des tests ----
      - name: Set up Docker Buildx
        if: success()
        uses: docker/setup-buildx-action@v3

      - name: Log in to private Docker registry
        if: success()
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        if: success()
        run: |
          echo "Building image $IMAGE_NAME:$TAG"
          docker build -f ./Dockerfile -t $IMAGE_NAME:$TAG -t $IMAGE_NAME:latest .

      - name: Push Docker image
        if: success()
        run: |
          echo "Pushing image $IMAGE_NAME:$TAG"
          docker push $IMAGE_NAME:$TAG
          docker push $IMAGE_NAME:latest

      - name: Notify Slack (success)
        if: success()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "text": ":white_check_mark: Déploiement réussi pour *${{ github.repository }}* !\nTag: *${{ env.TAG }}*"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # ---- En cas d’échec des tests ----
      - name: Notify Slack (failure)
        if: failure()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "text": ":x: Les tests unitaires ont échoué pour *${{ github.repository }}*.\nAucun déploiement n’a été effectué."
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
